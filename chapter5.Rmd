# Features on the entire dataset

## Data cleaning and features calculation

```{r  message=FALSE, warning=FALSE, include=FALSE}
## get full data that have patient id in clinical dataset
full_data <- ms_data2 %>% 
  subset(patient_id %in% intersect(patient_id, cl_data$NeurExPatientID))

full_attribute <- cl_data %>% 
  subset(NeurExPatientID %in% full_data$patient_id) %>% 
  dplyr::select(NeurExPatientID, diagnosis_group, gender, handedness, age) %>% 
  dplyr::rename(dominant_hand="handedness", patient_id= "NeurExPatientID")

full_data <- merge(full_attribute, full_data)

```



```{r  message=FALSE, warning=FALSE, include=FALSE}
## Clean healthy set of patients data
HV_Patient2 <- HV_Patient %>% 
  dplyr::group_by(patientID, difficulty) %>%
  dplyr::mutate(ntest_date = factor(testdate, labels = 1:length(unique(testdate)))) %>% 
  dplyr::select(trialID, patientID,x,y,t,p,ntest_date,difficulty, testdate, appendage) %>% 
  dplyr::rename(trial_id = trialID, patient_id=patientID,difficulty_level=difficulty)

HV_Patient2$t <- HV_Patient2$t/1000 ## convert time point from milliseconds to seconds 

## add time that is scaled from 0 by patient_id, ntest_date, and difficulty_level and remove duplicate x, y, t
HV_Patient2 <- HV_Patient2 %>% 
  dplyr::group_by(patient_id, ntest_date, difficulty_level, trial_id) %>% 
  dplyr::distinct(x,y,t,p, .keep_all = TRUE) %>% 
  dplyr::arrange(t) %>% 
  dplyr::mutate(pixel = row_number(), time = t-t[1])

## Add column to be used later
HV_Patient2$dominant_hand <- NA
HV_Patient2$gender <- NA
HV_Patient2$age <- NA
HV_Patient2$diagnosis_group <- "HV"

#### Combine Healthy Volunteers with full data
full_cname <- c("patient_id","ntest_date","difficulty_level", "trial_id", "x","y","t","p",
                 "pixel","diagnosis_group","time","gender","age","dominant_hand", 
                 "appendage", "testdate")
full_data <- as.data.frame(full_data[, full_cname])
HV_Patient2 <- as.data.frame(HV_Patient2[, full_cname])
full_data2 <- rbind(full_data, HV_Patient2)
full_data2 <- full_data2[1:(dim(full_data2)[1]-1),] ## Remove unclean last row with NAs

### Remove the outlier by trial group 
ptm <- proc.time() ## Check how long it will run (takes 8.65 min to run)
clean.full_data <- full_data2 %>% 
  dplyr::group_by(patient_id, ntest_date, difficulty_level, trial_id) %>%
  dplyr::group_modify(~outlier_func(.x))
proc.time() - ptm

clean.full_data2 <- as.data.frame(clean.full_data)

## Clean the data and remove duplicate and arrange by time 
clean.full_data2 <- clean.full_data2 %>% 
  dplyr::group_by(patient_id, ntest_date, difficulty_level, trial_id) %>% 
  dplyr::distinct(x,y,t,p, .keep_all = TRUE) %>% 
  dplyr::arrange(patient_id, ntest_date, difficulty_level, trial_id, time)

```




```{r  message=FALSE, warning=FALSE, include=FALSE}


# #### Calculate the velocities
# ptm <- proc.time() ## Check how long it will run (takes 50 min to run)
# full_data.vel <- veclocity_func(as.data.frame(clean.full_data2),"x" ,"y")
# proc.time() - ptm

full_data.vel <- read.csv("full_data.velocity.csv", header = TRUE) 

## Take magnitude of radial and angular velocity
full_data.vel$v_i <- abs(full_data.vel$v_i)
full_data.vel$rv_i <- abs(full_data.vel$rv_i)
full_data.vel$av_i <- abs(full_data.vel$av_i)

## Calculate the summary statistics of velocities
## calculate the sum, coefiicient of variation, skew for v, rv, and av
full_data.sum <- full_data.vel %>% 
  dplyr::group_by(patient_id,ntest_date,difficulty_level, trial_id) %>% 
  dplyr::summarise(v_sum = sum(v_i, na.rm = TRUE), v_cv = cv(v_i), 
            v_sk = skewness(v_i, na.rm = TRUE), v_kt = kurtosis(v_i, na.rm = TRUE), 
            rv_sum = sum(rv_i, na.rm = TRUE), rv_cv = cv(rv_i), 
            rv_sk = skewness(rv_i, na.rm = TRUE), rv_kt = kurtosis(rv_i, na.rm = TRUE),
            av_sum = sum(av_i, na.rm = TRUE), av_cv = cv(av_i), 
            av_sk = skewness(av_i, na.rm = TRUE), av_kt = kurtosis(av_i, na.rm = TRUE),
            pressure_sum = sum(p, na.rm = TRUE))

#### Power Spectral Density using Welsh periodogram with a Hamming window
full_data.psd <- full_data.vel %>% 
   dplyr::group_by(patient_id, ntest_date, difficulty_level, trial_id) %>%
  dplyr::summarise(v_psd.max = max(pwelch_func(filter_func(v_i,time,7))$spec, na.rm = TRUE), 
            v_df = pwelch_func(filter_func(v_i,time,7))$freq[which.max(pwelch_func(filter_func(v_i,time,7))$spec)],
            rv_psd.max = max(pwelch_func(filter_func(rv_i,time,7))$spec, na.rm = TRUE),
            rv_df = pwelch_func(filter_func(rv_i,time,7))$freq[which.max(pwelch_func(filter_func(rv_i,time,7))$spec)],
            av_psd.max = max(pwelch_func(filter_func(av_i,time,7))$spec, na.rm = TRUE),
            av_df = pwelch_func(filter_func(av_i,time,7))$freq[which.max(pwelch_func(filter_func(av_i,time,7))$spec)])



```



```{r  message=FALSE, warning=FALSE, include=FALSE}

### calculate data frame with hausdorff distance metrics
# ptm <- proc.time() ## Take 4.02 hours
# full_data.hausD <- HausData_func(full_data.vel, "x", "y")
# proc.time() - ptm
# 
# write.csv(full_data.hausD, file = "full_dataHausD.csv")

full_data.hausD <- read.csv("full_dataHausD.csv")

# ### calculate data frame with Area Under the curve
# ptm <- proc.time() ## Take 5.6 min
# full_data.Error <- Error_func(full_data.vel, "x", "y")
# proc.time() - ptm
# 
# write.csv(full_data.Error, file = "full_dataError.csv")

full_data.Error <- read.csv("full_dataError.csv")

### Approximate Entropy (ApEn)
## Interpolate all v_i, r_vi, av_i over a fixed length L = 500 (see similar approach in Creagh et al., 2020) and calculate their entropy 
full_data.apen <- full_data.vel %>% 
   dplyr::group_by(patient_id,ntest_date,difficulty_level, trial_id) %>%
  dplyr::summarise(v_apen = ApEn(spline(v_i, n = 500)$y), 
            rv_apen = ApEn(spline(rv_i, n = 500)$y), 
            av_apen = ApEn(spline(av_i, n = 500)$y))

```



```{r  message=FALSE, warning=FALSE, include=FALSE}

##Extract feateares from Hausdorff distance datataframe
full_data.hausD2 <- full_data.hausD %>% 
  dplyr::select(patient_id, ntest_date, difficulty_level, trial_id,
                hausD, hausDError, hausDt, hausDIqr, hausD25, hausD75, hausDmiddle, hausDmiddlet)
full_data.hausD2$difficulty_level <- factor(full_data.hausD2$difficulty_level, labels = c("1","2","3"))

##Extract feateares from Error datataframe
full_data.Error2 <- full_data.Error %>% 
  dplyr::select(patient_id, ntest_date, difficulty_level, trial_id,
                ErrAUC, MSE, RMSE, Center_Sh, t_final, total_asym, true_asym, Corr, 
                ImEntropy_pat, ImEntropy_ratio)
full_data.Error2$difficulty_level <- factor(full_data.Error2$difficulty_level, labels = c("1","2","3"))

##Extract age, diagnosis_group, and gender from Error datataframe
full_data.stat <- full_data.Error %>% 
  dplyr::select(patient_id, testdate, ntest_date, difficulty_level, trial_id, gender, 
                diagnosis_group, age, appendage, dominant_hand)
full_data.stat$difficulty_level <- factor(full_data.stat$difficulty_level, labels = c("1","2","3"))
full_data.stat$dominant_hand <- ifelse(full_data.stat$dominant_hand=="Right","RH","LH")

## Determine if patient use dominant hand or not
full_data.stat$dominant_hand_use <- ifelse(full_data.stat$appendage==full_data.stat$dominant_hand,
                                         "YES","NO")

## Merge all fetures
full_feature <- merge(full_data.stat, full_data.sum, by = merge_cols, all = TRUE)
full_feature <- merge(full_feature, full_data.psd, by = merge_cols, all = TRUE)
full_feature <- merge(full_feature, full_data.apen, by = merge_cols, all = TRUE)
full_feature <- merge(full_feature, full_data.hausD2, by = merge_cols, all = TRUE)
full_feature <- merge(full_feature, full_data.Error2, by = merge_cols, all = TRUE)

## Change the feature name with F1 to Fn
full.feature.name <- colnames(full_feature)[12:51]
new_full.feature.name <- paste(rep("F",length(full.feature.name)),1:length(full.feature.name),sep = "")

## To recognize which label is what column name
full_label_table <- data.frame(Label = new_full.feature.name, Name = full.feature.name)

## Change the patient feature label in dataframe
colnames(full_feature)[12:51] <- new_full.feature.name

```





```{r  message=FALSE, warning=FALSE, include=FALSE}
#### Extract information regarding healthy patient with names "PATIENT.."  
## Read in handedness data
handedness_data <- read.csv("Handedness.csv")
handedness_PATIENT <- handedness_data[grep("PATIENT", handedness_data$PatientCode),]

handedness_PATIENT <- handedness_PATIENT %>% 
  dplyr::select(PatientCode, Age, Gender) %>% 
  dplyr::rename(patient_id = "PatientCode", age="Age", gender="Gender") %>% 
  dplyr::mutate(dominant_hand ="RH") 


############# add dominant hand, age, gender to Healthy patient with name "PatientNN"
full_feature2 <- full_feature %>% 
  subset(diagnosis_group %in% c("HV","MS")) %>% # select only the HV and MS features
  dplyr::left_join(handedness_PATIENT, by = "patient_id") %>% 
  dplyr::mutate(age = coalesce(age.x,age.y),gender = coalesce(gender.x,gender.y),
                dominant_hand=coalesce(dominant_hand.x, dominant_hand.y)) %>% 
  dplyr::select(-c(age.x,age.y,gender.x,gender.y,dominant_hand.x,dominant_hand.y)) %>% 
  dplyr::select(patient_id, ntest_date, difficulty_level, trial_id, testdate,
                diagnosis_group, age, gender, appendage,dominant_hand, 
                dominant_hand_use, everything())
#full_feature2[grep("PATIENT",full_feature2$patient_id), "dominant_hand"] <- "RH"
full_feature2[, "dominant_hand_use"] <- 
  ifelse(full_feature2$appendage==full_feature2$dominant_hand, "YES", "NO")

#### Remove Training MS datasets and Training MS datasets
## convert cl_test sets dates to Dates format
cl_test2 <- cl_test
cl_test2$testdate <- as.Date(cl_test2$testdate, format = "%m/%d/%Y")
## Extract test set of MS 
full_feature_test <- full_feature2 %>% 
    dplyr::filter((patient_id %in% cl_test2$patient_id) & (testdate %in% cl_test2$testdate)) 

full_feature_train <- anti_join(full_feature2, full_feature_test, by = c("patient_id","testdate"))
```


## Extraction of longitudinal data

```{r  message=FALSE, warning=FALSE, include=FALSE}
## Extract HV and MS patients with longitudinal data
longi_pat <- full_feature2
longi_pat$ntest_date <- as.numeric(full_feature2$ntest_date)
longi_pat <- unique(subset(longi_pat, ntest_date >= 6)$patient_id)

longi_data <- subset(full_feature2, patient_id %in% longi_pat)

### Average features by trial_id group
longi_data.av <- longi_data %>% 
  dplyr::select(-c(trial_id, age, gender, appendage, dominant_hand)) %>% 
  group_by(patient_id, ntest_date, difficulty_level, diagnosis_group, dominant_hand_use) %>% 
  dplyr::summarise_all(.funs = mean)
  
  
```



```{r  message=FALSE, warning=FALSE, include=FALSE}
## Obtain demographic information of entire dataset

# Select difficulty level 1 and only MS and HV patients
full_data.stat_l1 <- full_feature2 %>% dplyr::filter(difficulty_level=="1")

## Find age attributes by HV and MS
age.stat <- full_data.stat_l1 %>% 
  group_by(diagnosis_group) %>% dplyr::select(age) %>% 
  summarise_each(funs(mean=mean(., na.rm = TRUE), 
                      sd=sd(., na.rm = TRUE), 
                      median = median(., na.rm = TRUE),
                      min = min(., na.rm = TRUE),
                      max = max(., na.rm = TRUE)))
  

## Total number of patient, number of dominant hands, and number of male\female by HV and MS
total_patient <- full_data.stat_l1 %>% 
  dplyr::select(diagnosis_group, patient_id, gender, dominant_hand, age) %>% 
  distinct(patient_id, .keep_all = TRUE) %>% 
  group_by(diagnosis_group) %>%
  dplyr::summarise(patient = n())

total_gender <- full_data.stat_l1 %>% 
  dplyr::select(diagnosis_group, patient_id, gender, dominant_hand, age) %>% 
  distinct(patient_id, .keep_all = TRUE) %>% 
  group_by(diagnosis_group,gender) %>%
  tally()

total_handedness <- full_data.stat_l1 %>% 
  dplyr::select(diagnosis_group, patient_id, gender, dominant_hand, age) %>% 
  distinct(patient_id, .keep_all = TRUE) %>% 
  group_by(diagnosis_group,dominant_hand) %>%
  tally()
    

## Obtain total number of granular and regular patient
total_granular_patient <- length(levels(factor(longi_data$patient_id)))
total_ngranular_patient <- (total_patient$patient[1]+total_patient$patient[2]) - total_granular_patient



```

## Calculate the interclass correlation Coefficient (ICC)

Given that we have test-rested (i.e. repeated measures of the same subject), it is advised in (Koo et al., 2016) to use the two-way mixed-effects model and the absolute agreement. See more detail in [here](https://www.datanovia.com/en/lessons/intraclass-correlation-coefficient-in-r/).

```{r  message=FALSE, warning=FALSE, include=FALSE}
##Extract HV and MS with  
longi_data.HV <- subset(longi_data.av, diagnosis_group=="HV")
longi_data.MS <- subset(longi_data.av, diagnosis_group=="MS")


## Extract dominant and non-dominant hands with difficulty levels
longi_data.HV.doml1 <- subset(longi_data.HV, (dominant_hand_use=="YES") & difficulty_level==1)
longi_data.HV.doml2 <- subset(longi_data.HV, (dominant_hand_use=="YES") & difficulty_level==2)
longi_data.HV.doml3 <- subset(longi_data.HV, (dominant_hand_use=="YES") & difficulty_level==3)
longi_data.HV.ndoml1 <- subset(longi_data.HV, (dominant_hand_use=="NO") & difficulty_level==1)
longi_data.HV.ndoml2 <- subset(longi_data.HV, (dominant_hand_use=="NO") & difficulty_level==2)
longi_data.HV.ndoml3 <- subset(longi_data.HV, (dominant_hand_use=="NO") & difficulty_level==3)

longi_data.MS.doml1 <- subset(longi_data.MS, dominant_hand_use=="YES" & difficulty_level==1)
longi_data.MS.doml2 <- subset(longi_data.MS, dominant_hand_use=="YES" & difficulty_level==2)
longi_data.MS.doml3 <- subset(longi_data.MS, dominant_hand_use=="YES" & difficulty_level==3)
longi_data.MS.ndoml1 <- subset(longi_data.MS, dominant_hand_use=="NO" & difficulty_level==1)
longi_data.MS.ndoml2 <- subset(longi_data.MS, dominant_hand_use=="NO" & difficulty_level==2)
longi_data.MS.ndoml3 <- subset(longi_data.MS, dominant_hand_use=="NO" & difficulty_level==3)

### Create a function to calculate the ICC per features
ICC_func <- function(data){
  ## data is dataframe containing all the features with attributes columns (diagnosis_group etc.)
  sub_data <- data %>% 
    ungroup() %>% 
    dplyr::select(-c(difficulty_level, testdate, diagnosis_group, dominant_hand_use))
  
  ## Function to remove columns with any NA and non-numeric value
  not_any_na <- function(x) all(!is.na(x) & is.numeric(x))
  n <- dim(sub_data)[2] ## get the size of the data
  icc_vec <- rep(0, 40)
  label <- paste(rep("F",40),1:40,sep = "")
  
  ## Loop through each features
  for (j in 3:n){
    Fj <- data.frame(patient = sub_data$patient_id, ntest = sub_data$ntest_date, 
                     feature = sub_data[,paste("F",j-2,sep = "")])
    ## Rearange ntest to be from 1 to n where n is the largest test that was taken
    Fj <- Fj %>% dplyr::select(-c(ntest)) %>% 
      group_by(patient) %>% 
      dplyr::mutate(ntest = row_number())
    Fj_wide <- tidyr::spread(Fj, ntest, paste("F",j-2,sep = "")) 
    ## Remove patient column
    Fj_wide <- Fj_wide %>% dplyr::ungroup() %>% dplyr::select(-c(patient)) 
    
    ## Remove NA columns and non-numeric
    Fj_wide_clean <- Fj_wide %>% select_if(not_any_na)
    ## Calculate ICC values
    icc_val <- icc(Fj_wide_clean, model = "twoway", type = "agreement", unit = "single")$value
    
    ## Update the icc vector 
    icc_vec[j-2] <- ifelse(icc_val<0,0,icc_val) ## set icc_val to 0 when it is negative
    
  }
  result  <- data.frame(Feature = label, ICC = icc_vec)
  result <- result %>% dplyr::mutate(Label = row_number())
  return(result)
}

#### Calculate ICC values
icc.HV.doml1 <- ICC_func(longi_data.HV.doml1)
icc.HV.doml2 <- ICC_func(longi_data.HV.doml2)
icc.HV.doml3 <- ICC_func(longi_data.HV.doml3)
icc.HV.ndoml1 <- ICC_func(longi_data.HV.ndoml1)
icc.HV.ndoml2 <- ICC_func(longi_data.HV.ndoml2)
icc.HV.ndoml3 <- ICC_func(longi_data.HV.ndoml3)

icc.MS.doml1 <- ICC_func(longi_data.MS.doml1)
icc.MS.doml2 <- ICC_func(longi_data.MS.doml2)
icc.MS.doml3 <- ICC_func(longi_data.MS.doml3)
icc.MS.ndoml1 <- ICC_func(longi_data.MS.ndoml1)
icc.MS.ndoml2 <- ICC_func(longi_data.MS.ndoml2)
icc.MS.ndoml3 <- ICC_func(longi_data.MS.ndoml3)

### Combine HV and MS
icc.HV.MS.doml1 <- rbind(data.frame(icc.HV.doml1,Diagnosis = "HV"), 
                         data.frame(icc.MS.doml1, Diagnosis = "MS"))
icc.HV.MS.doml2 <- rbind(data.frame(icc.HV.doml2,Diagnosis = "HV"), 
                         data.frame(icc.MS.doml2, Diagnosis = "MS"))
icc.HV.MS.doml3 <- rbind(data.frame(icc.HV.doml3,Diagnosis = "HV"), 
                         data.frame(icc.MS.doml3, Diagnosis = "MS"))

icc.HV.MS.ndoml1 <- rbind(data.frame(icc.HV.ndoml1,Diagnosis = "HV"), 
                         data.frame(icc.MS.ndoml1, Diagnosis = "MS"))
icc.HV.MS.ndoml2 <- rbind(data.frame(icc.HV.ndoml2,Diagnosis = "HV"), 
                         data.frame(icc.MS.ndoml2, Diagnosis = "MS"))
icc.HV.MS.ndoml3 <- rbind(data.frame(icc.HV.ndoml3,Diagnosis = "HV"), 
                         data.frame(icc.MS.ndoml3, Diagnosis = "MS"))

```


Now we construct a function to calculate the p-value between the HV and MS

```{r  message=FALSE, warning=FALSE, include=FALSE}


### Create a function to calculate the wilcoxon test to determine significance between HV and MS
HV.v.MS_func <- function(data, dominant, difficulty, group_var, Feat_ac){
  ## data is dataframe containing all the features with attributes columns (diagnosis_group etc.)
  # dominant is either YES or NO for dominant hand and difficulty is level 1 ,2, or 3
  ## group_var is the grouping variable
  ## Feat_ac is the feature acronym either F or C
  
  sub_data <- data %>% 
    subset((dominant_hand_use==dominant) & (difficulty_level==difficulty)) %>% 
    ungroup() %>% 
    dplyr::select(group_var, grep(Feat_ac,names(data), value = TRUE))
  
 
  f_numb <- dim(sub_data)[2] ## get the size of the data
  col_names <- colnames(sub_data)[2:f_numb]
  Group <- sub_data[,group_var]
  
  pval_table <- data.frame(Feature = paste(rep("F",40),1:40,sep = ""), pval = rep(0, 40), 
                           FC = rep(0, 40))
  count  = 0
  
  ## Loop through each features
  for (j in col_names){
    count = count + 1
    fi_data <- data.frame(Group = Group, Feature = sub_data[,j])
    colnames(fi_data) <- c("Group","Feature")
    res <- wilcox.test(Feature ~ Group, data = fi_data, exact = FALSE)
    pval <- res$p.value ## pvalue
    pval_table[count,"pval"] <- pval
    
    ## calculate fold change
    fold_change <- mean(gtools::foldchange(subset(fi_data, Group==levels(Group)[1])$Feature,
                                      subset(fi_data, Group==levels(Group)[2])$Feature))
      
    pval_table[count,"FC"] <- fold_change
    
  }
  return(pval_table)
}

## Compute pvalues by HV vs. MS
pval.doml1 <- HV.v.MS_func(full_feature_train, "YES", "1","diagnosis_group","F")
pval.doml2 <- HV.v.MS_func(full_feature_train, "YES", "2","diagnosis_group","F")
pval.doml3 <- HV.v.MS_func(full_feature_train, "YES", "3","diagnosis_group","F")

pval.ndoml1 <- HV.v.MS_func(full_feature_train, "NO", "1","diagnosis_group","F")
pval.ndoml2 <- HV.v.MS_func(full_feature_train, "NO", "2","diagnosis_group","F")
pval.ndoml3 <- HV.v.MS_func(full_feature_train, "NO", "3","diagnosis_group","F")

#### Combine P-value and ICC of healthy volunteers data frame
icc.pval.doml1 <- merge(icc.HV.doml1, pval.doml1, by = "Feature")
icc.pval.doml2 <- merge(icc.HV.doml2, pval.doml2, by = "Feature")
icc.pval.doml3 <- merge(icc.HV.doml3, pval.doml3, by = "Feature")

icc.pval.ndoml1 <- merge(icc.HV.ndoml1, pval.ndoml1, by = "Feature")
icc.pval.ndoml2 <- merge(icc.HV.ndoml2, pval.ndoml2, by = "Feature")
icc.pval.ndoml3 <- merge(icc.HV.ndoml3, pval.ndoml3, by = "Feature")

```






```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=12, fig.width= 16}

#### create template for plot labelling
black.bold.text1 <- element_text(face = "bold", color = "black",size=16) # x and y axis
black.bold.text2 <- element_text(face = "bold", color = "black",size=16) # title
Nice.Label2 <-theme(axis.text.x = element_text(face="bold", color="black", size=11),
         axis.text.y = element_text(face="bold", color="black", size=11),
         title=black.bold.text2,axis.title = black.bold.text1, legend.position = "bottom",
         legend.box = "vertical", 
         legend.text = element_text(size=24),strip.text.x = element_text(face="bold",size=24)) 
##################



######################################## PLOTTING ICC
#### Difficulty level 1
## dominant hand Difficulty level 1 
ggplot(icc.HV.MS.doml1, aes(x=reorder(Label,c(ICC[1:40],ICC[1:40])), y=ICC, fill=Diagnosis)) + 
    geom_bar(stat="identity", color="black", position=position_dodge()) + 
  labs(x = "Drawing Derived Features", y = "Intraclass Correlation Coefficient") + 
  scale_fill_manual(values = c("slategray2","steelblue")) +
  theme_bw() + theme(legend.position = "bottom") + Nice.Label2

## Non-dominant hand Difficulty level 1
ggplot(icc.HV.MS.ndoml1, aes(x=reorder(Label,c(ICC[1:40],ICC[1:40])), y=ICC, fill=Diagnosis)) + 
    geom_bar(stat="identity", color="black", position=position_dodge()) + 
  labs(x = "Drawing Derived Features", y = "Intraclass Correlation Coefficient") + 
  scale_fill_manual(values = c("slategray2","steelblue")) +
  theme_bw() + theme(legend.position = "bottom") + Nice.Label2

#### Difficulty level 2
## dominant hand Difficulty level 2 
ggplot(icc.HV.MS.doml2, aes(x=reorder(Label,c(ICC[1:40],ICC[1:40])), y=ICC, fill=Diagnosis)) + 
    geom_bar(stat="identity", color="black", position=position_dodge()) + 
  labs(x = "Drawing Derived Features", y = "Intraclass Correlation Coefficient") + 
  scale_fill_manual(values = c("slategray2","steelblue")) +
  theme_bw() + theme(legend.position = "bottom") + Nice.Label2

## Non-dominant hand Difficulty level 2
ggplot(icc.HV.MS.ndoml2, aes(x=reorder(Label,c(ICC[1:40],ICC[1:40])), y=ICC, fill=Diagnosis)) + 
    geom_bar(stat="identity", color="black", position=position_dodge()) + 
  labs(x = "Drawing Derived Features", y = "Intraclass Correlation Coefficient") + 
  scale_fill_manual(values = c("slategray2","steelblue")) +
  theme_bw() + theme(legend.position = "bottom") + Nice.Label2

#### Difficulty level 3
## dominant hand Difficulty level 3 
ggplot(icc.HV.MS.doml3, aes(x=reorder(Label,c(ICC[1:40],ICC[1:40])), y=ICC, fill=Diagnosis)) + 
    geom_bar(stat="identity", color="black", position=position_dodge()) + 
  labs(x = "Drawing Derived Features", y = "Intraclass Correlation Coefficient") + 
  scale_fill_manual(values = c("slategray2","steelblue")) +
  theme_bw() + theme(legend.position = "bottom") + Nice.Label2

## Non-dominant hand Difficulty level 3
ggplot(icc.HV.MS.ndoml3, aes(x=reorder(Label,c(ICC[1:40],ICC[1:40])), y=ICC, fill=Diagnosis)) + 
    geom_bar(stat="identity", color="black", position=position_dodge()) + 
  labs(x = "Drawing Derived Features", y = "Intraclass Correlation Coefficient") + 
  scale_fill_manual(values = c("slategray2","steelblue")) +
  theme_bw() + theme(legend.position = "bottom") + Nice.Label2


##################### PLOTTING ICC vs. Pvalue

ggplot(icc.pval.doml1, aes(x=FC, y=ICC, label = Label)) +
  geom_point(alpha=0.7, size = 8, color = "darkgray") +
  geom_text() +
  #scale_x_continuous(trans='log2') +
  theme_bw() + Nice.Label2
```




```{r  message=FALSE, warning=FALSE, include=FALSE}
#### Construct a function to extract data for venn diagram plotting
ICCven_func <- function(data, alpha){
  ## data is the dataframe containing feature labels, ICC value and diagnosis 
  ## alpha is the level at which we assume stability of the feature [0-1]
  
  ## Extract the HV and MS data
  hv_data <- subset(data, Diagnosis == "HV")
  ms_data <- subset(data, Diagnosis == "MS")
  
  ## extract the stable data
  stable_hv <- subset(hv_data, ICC>alpha)
  stable_ms <- subset(ms_data, ICC>alpha)
  
  return(list(MS = stable_ms$Feature, HV = stable_hv$Feature))
}
#### Difficulty level 1

ggpubr::ggarrange(ggVennDiagram(ICCven_func(icc.HV.MS.doml1,0.75), show.legend = FALSE),
                  ggVennDiagram(ICCven_func(icc.HV.MS.ndoml1,0.75), show.legend = FALSE),
                  labels = c("Dominant", "Non-dominant"), ncol = 1, nrow = 2)

#### Difficulty level 2
ggpubr::ggarrange(ggVennDiagram(ICCven_func(icc.HV.MS.doml2,0.75), show.legend = FALSE),
                  ggVennDiagram(ICCven_func(icc.HV.MS.ndoml2,0.75), show.legend = FALSE),
                  labels = c("Dominant", "Non-dominant"), ncol = 1, nrow = 2)

#### Difficulty level 3
ggpubr::ggarrange(ggVennDiagram(ICCven_func(icc.HV.MS.doml3,0.75), show.legend = FALSE),
                  ggVennDiagram(ICCven_func(icc.HV.MS.ndoml3,0.75), show.legend = FALSE),
                  labels = c("Dominant", "Non-dominant"), ncol = 1, nrow = 2)

```

## Statistical significance of Features that are highly stable by ICC (ICC>0.75)


```{r  message=FALSE, warning=FALSE, include=FALSE}

#### Second function to only calculate statistical significant differences for one DL level

## Construct a function to conduct the wilcoxon test between HV and MS cohorts
## and return features that are significant at each difficulty level

wtest_func_onedl <- function(data, alpha, group_var, Feat_ac){
  ## Data is dataframe containing features and the first column being the categorical variables
  ## alpha is the alpha level (e.g 0.05)
  ## group_var is the grouping variable
  ## Feat_ac is the feature acronym either F or C
  
  ## Remove irrelevent columns and rows
  sub_data <- data %>% ungroup() %>% 
    dplyr::select(group_var, grep(Feat_ac,names(data), value = TRUE))
  
    f_numb <- dim(sub_data)[2]
    col_names <- colnames(sub_data)[2:f_numb]
    
    Group <- sub_data[,group_var]
    
    sign_features <- c() 
    
    for (j in col_names){
      fi_data <- data.frame(Group = Group, Feature = sub_data[,j])
      colnames(fi_data) <- c("Group","Feature")
      res <- wilcox.test(Feature ~ Group, data = fi_data, exact = FALSE)
      pval <- res$p.value
      
      if (pval < alpha){
      sign_features <- c(sign_features, j)
      }
    }
    if (Feat_ac=="F" & is.null(sign_features)){
    sign_features <- c("F38","F32","F33")
    } else {
    sign_features <- sign_features
    }
  return(sign_features)
  
} 

#############################

## Conduct the wilcoxon test between HV and MS cohorts for Features that are stables by ICC>0.5

#### Get Features that are stable for the Healthy Volunteers
StableF_doml1 <- ICCven_func(icc.HV.MS.doml1,0.5)$HV
StableF_ndoml1 <- ICCven_func(icc.HV.MS.ndoml1,0.5)$HV
StableF_doml2 <- ICCven_func(icc.HV.MS.doml2,0.5)$HV
StableF_ndoml2 <- ICCven_func(icc.HV.MS.ndoml2,0.5)$HV
StableF_doml3 <- ICCven_func(icc.HV.MS.doml3,0.5)$HV
StableF_ndoml3 <- ICCven_func(icc.HV.MS.ndoml3,0.5)$HV

#####################

## Remove all features that are not stable
## Difficulty Level 1
full_feat_train_Sdoml1 <- full_feature_train %>% 
  subset(difficulty_level=="1" & dominant_hand_use=="YES") %>% 
  dplyr::select(-setdiff(paste("F",1:40,sep =""), StableF_doml1)) 
full_feat_train_Sndoml1 <- full_feature_train %>% 
  subset(difficulty_level=="1" & dominant_hand_use=="NO") %>% 
  dplyr::select(-setdiff(paste("F",1:40,sep =""), StableF_ndoml1)) 

## Difficulty Level 2
full_feat_train_Sdoml2 <- full_feature_train %>% 
  subset(difficulty_level=="2" & dominant_hand_use=="YES") %>% 
  dplyr::select(-setdiff(paste("F",1:40,sep =""), StableF_doml2)) 
full_feat_train_Sndoml2 <- full_feature_train %>% 
  subset(difficulty_level=="2" & dominant_hand_use=="NO") %>% 
  dplyr::select(-setdiff(paste("F",1:40,sep =""), StableF_ndoml2)) 

## Difficulty Level 3
full_feat_train_Sdoml3 <- full_feature_train %>% 
  subset(difficulty_level=="3" & dominant_hand_use=="YES") %>% 
  dplyr::select(-setdiff(paste("F",1:40,sep =""), StableF_doml3)) 
full_feat_train_Sndoml3 <- full_feature_train %>% 
  subset(difficulty_level=="3" & dominant_hand_use=="NO") %>% 
  dplyr::select(-setdiff(paste("F",1:40,sep =""), StableF_ndoml3)) 

##### Statistical Significant Features
## DL1
wtest_func_onedl(full_feat_train_Sdoml1, 0.001, "diagnosis_group", "F")
wtest_func_onedl(full_feat_train_Sndoml1, 0.001, "diagnosis_group", "F")

## DL2
wtest_func_onedl(full_feat_train_Sdoml2, 0.001, "diagnosis_group", "F")
wtest_func_onedl(full_feat_train_Sndoml2, 0.001, "diagnosis_group", "F")

## DL3
wtest_func_onedl(full_feat_train_Sdoml2, 0.001, "diagnosis_group", "F")
wtest_func_onedl(full_feat_train_Sndoml2, 0.001, "diagnosis_group", "F")


```




```{r  message=FALSE, warning=FALSE, include=FALSE}
#### Here we extract clinical features that are significant at 0.001
## First we extract HV and MS from diagnosis 

cl_feature.HV.MS <- cl_data.sub %>% 
  subset(diagnosis_group %in% c("HV","MS")) %>% 
  dplyr::select(patient_id, testdate, neuro_testdate, apptest_to_neurotest, gender, 
                diagnosis, diagnosis_group, dominant_hand, age, X9HPT.Avg, BMI, everything())
colnames(cl_feature.HV.MS)[10:41] <- paste("C",1:32, sep ="")


##### Statistical Significant Features
wtest_func_onedl(cl_feature.HV.MS, 0.001, "diagnosis_group","C")

## Clinical feature with features that are significant
cl_feat_sign <- cl_feature.HV.MS %>% 
  dplyr::select(diagnosis_group,wtest_func_onedl(cl_feature.HV.MS, 0.001, "diagnosis_group","C")) 

cl_feat_signHV <- cl_feat_sign %>% 
  dplyr::filter(diagnosis_group=="HV") %>% 
  dplyr::select(-c(diagnosis_group))

cl_feat_signMS <- cl_feat_sign %>% 
  dplyr::filter(diagnosis_group=="MS") %>% 
  dplyr::select(-c(diagnosis_group))

```


## Correlation between Patient derived features and clinical features

Here we focus on patients drawing features that are stable and statistically significant and clinical features that are statistically significant at the level 0.001 and correlation were implemented between these two type of features. 


```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=12, fig.width= 16}

## Function to extract and plot correplot between shape drawn feature and clinical features
## that are statistically significant

mat.feat_func.onel <- function(pat_data,cl_data, diagnosis, alpha){
  ## pat_data is data of shape drawn feature that are stable 
  ## and cl_data is clinical feature data
  ## diagnosis is diagnosis group
  ## alpha is the alpha level for significance
 
  
  cl_data$testdate <- as.Date(cl_data$testdate, format = "%m/%d/%Y")
  pat_data$testdate <- as.Date(pat_data$testdate) 
  ## return all rowss from pat_data where there are matching in cl_data and columns from both
  merge_data <- dplyr::left_join(pat_data, cl_data, by =c("patient_id","testdate","diagnosis_group"))
  #merge_data <- dplyr::semi_join(merge_data, cl_data, by =c("patient_id","testdate","diagnosis_group"))
  
  cl_sub <- merge_data %>% ungroup() %>%  
    dplyr::select(diagnosis_group, wtest_func_onedl(cl_data, alpha, "diagnosis_group", "C")) %>% 
    dplyr::filter(diagnosis_group==diagnosis) %>% 
    dplyr::select(-c(diagnosis_group))
  
  
  pat_sub <- merge_data %>% ungroup() %>% 
    dplyr::select(diagnosis_group, intersect(names(dplyr::select(merge_data %>% ungroup(),starts_with("F"))), wtest_func_onedl(pat_data, alpha, "diagnosis_group", "F"))) %>%
    # dplyr::select(diagnosis, paste("F",1:40, sep = "")) %>% 
    dplyr::filter(diagnosis_group==diagnosis) %>% 
    dplyr::select(-c(diagnosis_group))
  
  
  
  ## Calculate correlation matrix and corresponding p-value
  cor_mat <- rcorr(as.matrix(cl_sub), as.matrix(pat_sub), type = cor_type)
  ## number of clinical features and correlation matrix size
  n_cl <- dim(cl_sub)[2]
  n <- dim(cor_mat$r)[2]
  # r_pat_cl <- cor_mat$r[1:18,19:n]
  # p_pat_cl <- cor_mat$P[1:18,19:n]
  r_pat_cl <- cor_mat$r[(n_cl+1):n,1:n_cl]
  p_pat_cl <- cor_mat$P[(n_cl+1):n,1:n_cl]
  n_pat_cl <- cor_mat$n[(n_cl+1):n,1:n_cl]
  #  ## plot
  corrplot(r_pat_cl, type="full", order="original", col = col_cor,
         p.mat = p_pat_cl, sig.level = 0.05, insig = "blank", diag = TRUE,
         tl.col = "black", tl.cex = 1.1, font.lab=2, cl.cex = 1.2, na.label = "NA")
  return(list(cl_data =cl_sub, pat_data=pat_sub, r=r_pat_cl, P=p_pat_cl, n=n_pat_cl))
  # return(list(cl_data =cl_sub, pat_data=pat_sub))
} 

#### Correlation plots

## Difficulty Level 1
mat.feat_func.onel(full_feat_train_Sdoml1,cl_feature.HV.MS,"HV",0.001)
mat.feat_func.onel(full_feat_train_Sdoml1,cl_feature.HV.MS,"MS",0.001)
mat.feat_func.onel(full_feat_train_Sndoml1,cl_feature.HV.MS,"HV",0.001)
mat.feat_func.onel(full_feat_train_Sndoml1,cl_feature.HV.MS,"MS",0.001)

## Difficulty Level 2
mat.feat_func.onel(full_feat_train_Sdoml2,cl_feature.HV.MS,"HV",0.001)
mat.feat_func.onel(full_feat_train_Sdoml2,cl_feature.HV.MS,"MS",0.001)
mat.feat_func.onel(full_feat_train_Sndoml2,cl_feature.HV.MS,"HV",0.001)
mat.feat_func.onel(full_feat_train_Sndoml2,cl_feature.HV.MS,"MS",0.001)

## Difficulty Level 3
mat.feat_func.onel(full_feat_train_Sdoml3,cl_feature.HV.MS,"HV",0.001)
mat.feat_func.onel(full_feat_train_Sdoml3,cl_feature.HV.MS,"MS",0.001)
mat.feat_func.onel(full_feat_train_Sndoml3,cl_feature.HV.MS,"HV",0.001)
mat.feat_func.onel(full_feat_train_Sndoml3,cl_feature.HV.MS,"MS",0.001)
#### Investigate correlation through chart plot

# #### Significant in HV but not in MS
# try <- full_feat_train_Sdoml1 %>% dplyr::select(-c(trial_id, age, gender, appendage, dominant_hand, dominant_hand_use, difficulty_level)) %>% 
#     group_by(patient_id, ntest_date, diagnosis_group) %>% 
#     dplyr::summarise_all(.funs = mean)
# 
# try <- subset(full_feat_train_Sdoml1, age<50)
# 
# data11 <- na.omit(data.frame(mat.feat_func.onel(try,cl_feature.HV.MS,"HV",0.001)$pat_data[,c("F5","F38")], mat.feat_func.onel(try,cl_feature.HV.MS,"HV",0.001)$cl_data[,c("C8","C21")]))
# data12 <- na.omit(data.frame(mat.feat_func.onel(try,cl_feature.HV.MS,"MS",0.001)$pat_data[,c("F5","F38")], mat.feat_func.onel(try,cl_feature.HV.MS,"MS",0.001)$cl_data[,c("C8","C21")]))


data11 <- na.omit(data.frame(mat.feat_func.onel(full_feat_train_Sdoml1,cl_feature.HV.MS,"HV",0.001)$pat_data[,c("F29","F38")], mat.feat_func.onel(full_feat_train_Sdoml1,cl_feature.HV.MS,"HV",0.001)$cl_data[,c("C1","C9")]))
data12 <- na.omit(data.frame(mat.feat_func.onel(full_feat_train_Sdoml1,cl_feature.HV.MS,"MS",0.001)$pat_data[,c("F29","F38")], mat.feat_func.onel(full_feat_train_Sdoml1,cl_feature.HV.MS,"MS",0.001)$cl_data[,c("C1","C9")]))

PerformanceAnalytics::chart.Correlation(data11, histogram=TRUE, pch=19, method = "spearman")

data21 <- na.omit(data.frame(mat.feat_func.onel(full_feat_train_Sdoml2,cl_feature.HV.MS,"HV",0.001)$pat_data[,c("F20","F21")], mat.feat_func.onel(full_feat_train_Sdoml2,cl_feature.HV.MS,"HV",0.001)$cl_data[,c("C4","C7")]))
data22 <- na.omit(data.frame(mat.feat_func.onel(full_feat_train_Sdoml2,cl_feature.HV.MS,"MS",0.001)$pat_data[,c("F20","F21")], mat.feat_func.onel(full_feat_train_Sdoml2,cl_feature.HV.MS,"MS",0.001)$cl_data[,c("C4","C7")]))

PerformanceAnalytics::chart.Correlation(data21, histogram=TRUE, pch=19, method = "spearman")


#### Check data 
pat <- full_feat_train_Sdoml1
pat$testdate <- as.Date(pat$testdate)
cl <- cl_feature.HV.MS
cl$testdate <- as.Date(cl$testdate,format = "%m/%d/%Y")

m_data <- dplyr::left_join(pat,cl,by =c("patient_id","testdate","diagnosis_group"))

cl_s <-  m_data %>% ungroup() %>% 
  dplyr::select(patient_id, ntest_date, difficulty_level, trial_id, diagnosis_group, wtest_func_onedl(cl, 0.001, "diagnosis_group", "C")) 

pat_s <- m_data %>%  ungroup() %>% 
  dplyr::select(patient_id, ntest_date, difficulty_level, trial_id, diagnosis_group, intersect(names(dplyr::select(m_data %>% ungroup(),starts_with("F"))), wtest_func_onedl(pat, 0.001, "diagnosis_group", "F")))


m_data_s <- dplyr::filter(m_data, difficulty_level=="1" & dominant_hand_use =="YES" & diagnosis_group=="MS")


plot1 <- ggplot(data=m_data_s, aes(label = patient_id, label2 = ntest_date, label3 = difficulty_level, label4=trial_id)) + geom_point(aes(x=F29, y = F38), size = 2, color = "black")  +theme_bw()

plotly::ggplotly(plot1)

###### Correlation plot of the significant clinical features
## Healthy Cohorts
res_cl.HV.S <- rcorr(as.matrix(cl_feat_signHV), type = cor_type)

corrplot(res_cl.HV.S$r, type="upper", order="original", col = col,
         p.mat = res_cl.HV.S$P, sig.level = 0.05, insig = "blank", diag = TRUE,
         tl.col = "black", tl.cex = 1.1, font.lab=2, cl.cex = 1.2, na.label = "NA")


## MS Cohorts
res_cl.MS.S <- rcorr(as.matrix(cl_feat_signMS), type = cor_type)

corrplot(res_cl.MS.S$r, type="upper", order="original", col = col,
         p.mat = res_cl.MS.S$P, sig.level = 0.05, insig = "blank", diag = TRUE,
         tl.col = "black", tl.cex = 1.1, font.lab=2, cl.cex = 1.2, na.label = "NA")

```


## Clinical feature selection
Here we will select only a number of clinical features using high correlation test and also removing features that havce all 0 in the Healthy cohorts (Feature 15, 16, 26, 27, and 28)


```{r  message=FALSE, warning=FALSE, include=FALSE}

## First we remove features that are 0 in the healthy cohorts and also features that are highly correlated

## Healthy Cohorst
cl_feat_signHV2 <- cl_feat_signHV #%>% dplyr::select(-c(C15, C16, C26, C27, C28))
res_cl.HV.S2 <- rcorr(as.matrix(cl_feat_signHV2), type = cor_type)

cl_feat_signHV2 <- cl_feat_signHV2 %>%
  dplyr::select(-caret::findCorrelation(na.omit(res_cl.HV.S2$r), cutoff = 0.7, names = TRUE))

## MS Cohorts
cl_feat_signMS2 <- cl_feat_signMS %>%
  dplyr::select(-caret::findCorrelation(na.omit(res_cl.MS.S$r), cutoff = 0.7, names = TRUE))


###### Correlation plot of the significant clinical features
## Healthy Cohorts
res_cl.HV.S2 <- rcorr(as.matrix(cl_feat_signHV2), type = cor_type)

corrplot(res_cl.HV.S2$r, type="upper", order="original", col = col,
         p.mat = res_cl.HV.S2$P, sig.level = 0.05, insig = "blank", diag = TRUE,
         tl.col = "black", tl.cex = 1.1, font.lab=2, cl.cex = 1.2, na.label = "NA")


## MS Cohorts
res_cl.MS.S2 <- rcorr(as.matrix(cl_feat_signMS2), type = cor_type)

corrplot(res_cl.MS.S2$r, type="upper", order="original", col = col,
         p.mat = res_cl.MS.S2$P, sig.level = 0.05, insig = "blank", diag = TRUE,
         tl.col = "black", tl.cex = 1.1, font.lab=2, cl.cex = 1.2, na.label = "NA")

# data1 <- full_feat_train_Sdoml3
# View(rcorr(as.matrix(subset(data1 %>% dplyr::select(diagnosis_group, wtest_func_onedl(data1, 0.001, "diagnosis_group","F")), diagnosis_group=="HV")[,-1]), type = cor_type)$r)

## rcorr(as.matrix(full_feat_train_Sdoml1 %>% dplyr::select(wtest_func_onedl(full_feat_train_Sdoml1, 0.001, "diagnosis_group","F"))))$r

# MSdoml1 <- subset(full_feature_train, dominant_hand_use=="YES" & diagnosis_group=="MS" & difficulty_level==1)
# MSdoml1p <- tidyr::gather(MSdoml1[,-c(1:11)], Feature, Value, F1:F40, factor_key = TRUE)
# 
# 
# ggplot(MSdoml1p, aes(x=Value)) + geom_histogram() + facet_wrap(~Feature, scales = "free")
# 
# 
# sub1_MSdoml1 <- dplyr::filter(MSdoml1, F5<0)
# sub2_MSdoml1 <- dplyr::filter(MSdoml1, F5>0)

```





